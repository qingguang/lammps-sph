echo               both
log                ${dname}/log.lammps
dimension          ${ndim}
units              si
atom_style   hybrid  bond meso
#atom_style        meso
boundary          p p p
# create simulation box
#3D box
include             ${ndim}-vars.lmp
read_data           poly3d.txt

special_bonds   lj 1 1 1
bond_style fene
bond_coeff 1 ${H} ${r0}  0 0

mass               1 ${sdpd_mass}
set                group all meso_rho ${sdpd_rho}


# use Tait's EOS in combination with Morris' laminar viscosity.
# We set rho_0 = 1000 kg/m^3, c = 0.1 m/s, h = 6.5e-5 m.
# The dynamic viscosity is set to 1.0e-3 Pa s, corresponding to a kinematic viscosity of 1.0e-6 m^2/s

pair_style         hybrid/overlay sph/rhosum 1 sdpd
pair_coeff         * * sph/rhosum   ${h}
#variable           sdpd_temp index 5e9
#pair_coeff         * *    sdpd ${sdpd_rho} ${sdpd_c} ${sdpd_eta} ${h} ${sdpd_temp}
pair_coeff          * *  sdpd ${sdpd_rho} ${sdpd_c} ${sdpd_eta} ${h} ${sdpd_temp} ${sdpd_background}

compute            rho_peratom all meso_rho/atom
#compute            e_peratom all meso_e/atom
#compute            ke_peratom all ke/atom
#compute            esph all reduce sum c_e_peratom
#compute            ke all ke
compute            sdpd_kin all temp
#variable           etot equal c_ke+c_esph



# do full time integration
fix            integrate_fix_full all meso

# Lees Edwards type boundary conditions

fix		deform_id  all deform 1 xy erate ${def_rate} remap v units box


#variable     xo     atom xs/${Lx}
#variable     yo     atom ys/${Ly}
#variable     zo     atom zs/${Lz}

thermo_style       custom step c_sdpd_kin
thermo_modify      norm no
thermo             100

##dump imgDump all image 1000 ${dname}/image.*.jpg type type atom yes bond type 5e-6 adiam 8e-6 view 0 0 zoom 1.3  box yes 0.01
##dump_modify        imgDump pad 9
##dump imgDump2 all image 1000 ${dname}/image2.*.jpg type type atom yes bond type 5e-6 adiam 8e-6 view 60 60 zoom 1.3  box yes 0.01
##dump_modify        imgDump2 pad 9


neighbor           3.0e-6 bin
neigh_modify       delay 0 every 1

include            settimestep.lmp
timestep           ${dt}

communicate        single vel yes

# average velocity

variable          Nfreq equal 1000
compute vxav all reduce ave vx
variable  vx_cm atom vx-c_vxav
fix av_vx all ave/spatial 1 ${Nfreq} ${Nfreq} &
y center 0.01 v_vx_cm file ${dname}/vx.av ave running units reduced
#run 400
include stress.lmp
include             ${ndim}-image.lmp

dump               dump_stress all custom ${Nfreq} ${dname}/stress*.dat &
    id  x y z &
    c_astress[1] c_astress[2] c_astress[3] &
    c_astress[4] c_astress[5] c_astress[6] 

dump_modify        dump_stress first yes
dump_modify        dump_stress sort id
dump_modify        dump_stress pad 8


dump               dump_id all custom 1000 ${dname}/dump*.dat id type x y z vx vy vz c_rho_peratom
dump_modify        dump_id first yes
dump_modify        dump_id sort id
dump_modify        dump_id pad 8

#dump               dumpu_idu all custom 1000 ${dname}/dumpu*.dat id type xu yu zu vx vy vz c_rho_peratom
#dump_modify        dumpu_idu first yes
#dump_modify        dumpu_idu sort id
#dump_modify        dumpu_idu pad 8
#dump               dumpu_ids all custom 1000 ${dname}/dumps*.dat id type xs ys zs vx vy vz c_rho_peratom
#dump_modify        dumpu_ids first yes
#dump_modify        dumpu_ids sort id
#dump_modify        dumpu_ids pad 8
#dump               dumpu_idsu all custom 1000 ${dname}/dumpsu*.dat id type xsu ysu zsu vx vy vz c_rho_peratom
#dump_modify        dumpu_idsu first yes
#dump_modify        dumpu_idsu sort id
#dump_modify        dumpu_idsu pad 8

#run 1000
#fix            deform_id  all deform 1 xy erate ${def_rate} remap v units box

run                400000
